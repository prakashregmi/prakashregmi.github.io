name: Create Release Tag

on:
    workflow_dispatch:
      inputs:
        version_type:
          description: 'Type of version bump (minor or patch)'
          required: true
          default: 'minor'
          type: choice
          options:
            - minor
            - patch
        service:
          description: 'Service name for the release'
          required: true
          default: 'go'
          type: choice
          options:
            - go
            - orkes

jobs:
    create_release:
      runs-on: ubuntu-latest
      permissions:
        contents: write

      steps:
        - name: Checkout code (fetch all tags)
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.PAT_TOKEN_PRAKASH }}

        - name: Calculate Next Version
          id: calculate_version
          run: |
            LATEST_TAG=$(git describe --tags --abbrev=0 --exclude='ci/*' 2>/dev/null || echo "0.0.0")
            echo "Last Tag Found: $LATEST_TAG"

            VERSION_NUMBERS=$(echo $LATEST_TAG | sed 's/^v//I' | tr '.' ' ')

            MAJOR=$(echo $VERSION_NUMBERS | awk '{print $1}' || echo "0")
            MINOR=$(echo $VERSION_NUMBERS | awk '{print $2}' || echo "0")
            PATCH=$(echo $VERSION_NUMBERS | awk '{print $3}' || echo "0")

            MAJOR=${MAJOR:-0}
            MINOR=${MINOR:-0}
            PATCH=${PATCH:-0}

            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            NEXT_TAG=""

            if [ "$VERSION_TYPE" == "minor" ]; then
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
              NEXT_TAG="$MAJOR.$NEW_MINOR.$NEW_PATCH"
            elif [ "$VERSION_TYPE" == "patch" ]; then
              NEW_PATCH=$((PATCH + 1))
              NEXT_TAG="$MAJOR.$MINOR.$NEW_PATCH"
            else
              echo "::error::Invalid version_type specified: $VERSION_TYPE. Must be 'minor' or 'patch'."
              exit 1
            fi

            echo "Next Tag Calculated: $NEXT_TAG"

            echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
            echo "last_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

        - name: Get Short SHA
          id: sha
          run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

        - name: Create GitHub Release and Tag
          uses: softprops/action-gh-release@v2
          if: steps.calculate_version.outputs.next_tag != ''
          with:
            tag_name: ${{ steps.calculate_version.outputs.next_tag }}
            name: ${{github.event.inputs.service}} - Release ${{ steps.calculate_version.outputs.next_tag }} (${{ steps.sha.outputs.short_sha }})
            generate_release_notes: true
            draft: false
            prerelease: false

        - name: Force Tag ci/prod and Push
        if: github.event.inputs.service == 'go'
          run: |
            echo "Force-creating ci/prod tag on current commit..."
            git tag -f ci/prod

            echo "Force-pushing ci/prod tag to origin..."
            git push origin ci/prod -f
